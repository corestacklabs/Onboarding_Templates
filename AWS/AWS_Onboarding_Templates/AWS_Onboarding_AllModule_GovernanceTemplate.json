{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Creates a new IAM role for your AWS Master account with Read & Write permissions needed for CloudOps, Finops & SecOps Bundle",
   "Parameters":{
      "RoleName":{
         "Type":"String",
         "Description":"The name of the IAM role to create. Use alphanumeric and '+=,.@-_' characters.",
         "AllowedPattern":"[\\w+=,.@-]{1,64}",
         "MinLength":"1",
         "MaxLength":"64"
      },
      "AssessmentPermissionInclude":{
         "Type":"String",
         "Description":"Permission to include Wellarchitected Read & Write Access",
         "Default":"Deny",
         "AllowedValues":[
            "Allow",
            "Deny"
         ]
      }
   },
   "Conditions":{
      "AssessmentAllow":{
         "Fn::Not":[
            {
               "Fn::Equals":[
                  {
                     "Ref":"AssessmentPermissionInclude"
                  },
                  "Deny"
               ]
            }
         ]
      }
   },
   "Resources":{
      "ConfigPermission":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CoreStack_ConfigPermission",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Sid":"Auth",
                     "Action":[
                        "config:DeleteConfigRule",
                        "config:PutConfigRule",
                        "config:PutEvaluations",
                        "config:TagResource"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"RoleName"
               }
            ]
         }
      },
      "TaggingGovernance":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CoreStack_TaggingGovernance",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Sid":"Auth",
                     "Action":[
                        "appstream:TagResource",
                        "cloudformation:TagResource",
                        "cloudfront:TagResource",
                        "cloudtrail:AddTags",
                        "cloudwatch:TagResource",
                        "directconnect:TagResource",
                        "ds:AddTagsToResource",
                        "dynamodb:TagResource",
                        "ec2:CreateTags",
                        "ec2:DeleteTags",
                        "ec2:UpdateTags",
                        "ecs:TagResource",
                        "eks:TagResource",
                        "elasticache:AddTagsToResource",
                        "elasticfilesystem:CreateTags",
                        "elasticfilesystem:TagResource",
                        "elasticloadbalancing:AddTags",
                        "es:AddTags",
                        "guardduty:TagResource",
                        "iam:TagRole",
                        "inspector:SetTagsForResource",
                        "kinesis:AddTagsToStream",
                        "kms:TagResource",
                        "kms:UntagResource",
                        "lambda:AddTagsToResource",
                        "lambda:TagResource",
                        "lightsail:TagResource",
                        "organizations:TagResource",
                        "rds:AddTagsToResource",
                        "redshift:CreateTags",
                        "s3:DeleteObjectTagging",
                        "secretsmanager:TagResource",
                        "secretsmanager:UntagResource",
                        "sns:TagResource",
                        "sqs:TagQueue",
                        "tag:TagResources",
                        "waf:TagResource",
                        "workspaces:CreateTags",
                        "workspaces:DeleteTags",
                        "route53resolver:TagResource"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"RoleName"
               }
            ]
         }
      },
      "AssessmentWritePermission":{
         "Type":"AWS::IAM::Policy",
         "Condition":"AssessmentAllow",
         "Properties":{
            "PolicyName":"CoreStack_AssessmentWritePermission",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Sid":"Auth",
                     "Action":[
                        "wellarchitected:AssociateLenses",
                        "wellarchitected:CreateMilestone",
                        "wellarchitected:CreateWorkload",
                        "wellarchitected:UpdateAnswer"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"RoleName"
               }
            ]
         }
      },
      "IAMWritePermission":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CoreStack_IAMWritePermission",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Sid":"Auth",
                     "Action":[
                        "iam:CreateRole",
                        "iam:CreateServiceLinkedRole",
                        "iam:DeleteRole",
                        "iam:DeleteRolePolicy",
                        "iam:PutRolePolicy",
                        "iam:UpdateAssumeRolePolicy"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"RoleName"
               }
            ]
         }
      },
      "InventoryWritePolicy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CoreStack_InventoryWritePolicy",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Sid":"Auth",
                     "Action":[
                        "autoscaling:AttachInstances",
                        "cloudformation:CreateStack",
                        "cloudformation:DeleteStack",
                        "cloudformation:UpdateStack",
                        "cloudtrail:CreateTrail",
                        "cloudtrail:DeleteTrail",
                        "cloudtrail:PutEventSelectors",
                        "cloudtrail:StartLogging",
                        "cloudtrail:UpdateTrail",
                        "cloudwatch:DeleteAlarms",
                        "cloudwatch:DisableAlarmActions",
                        "cloudwatch:EnableAlarmActions",
                        "cloudwatch:PutMetricAlarm",
                        "dms:DeleteEndpoint",
                        "dms:DeleteReplicationInstance",
                        "dms:DeleteReplicationTask",
                        "dynamodb:CreateTable",
                        "dynamodb:DeleteTable",
                        "dynamodb:UpdateTable",
                        "ec2:AllocateAddress",
                        "ec2:AssociateIamInstanceProfile",
                        "ec2:AttachNetworkInterface",
                        "ec2:AttachVolume",
                        "ec2:CancelSpotFleetRequests",
                        "ec2:CancelSpotInstanceRequests",
                        "ec2:CopySnapshot",
                        "ec2:Create*",
                        "ec2:Delete*",
                        "ec2:DeregisterImage",
                        "ec2:DetachNetworkInterface",
                        "ec2:DetachVolume",
                        "ec2:DisassociateAddress",
                        "ec2:DisassociateSubnetCidrBlock",
                        "ec2:EnableVolumeIO",
                        "ec2:Modify*",
                        "ec2:MonitorInstances",
                        "ec2:RebootInstances",
                        "ec2:RegisterImage",
                        "ec2:ReleaseAddress",
                        "ec2:RunInstances",
                        "ec2:StartInstances",
                        "ec2:StopInstances",
                        "ec2:TerminateInstances",
                        "ec2:UnmonitorInstances",
                        "ecr:BatchDeleteImage",
                        "ecs:CreateCluster",
                        "ecs:DeleteCluster",
                        "ecs:UpdateCluster",
                        "elasticache:Delete*",
                        "elasticloadbalancing:CreateLoadBalancer",
                        "elasticloadbalancing:DeleteLoadBalancer",
                        "elasticloadbalancing:DeregisterInstancesFromLoadBalancer",
                        "elasticloadbalancing:ModifyLoadBalancerAttributes",
                        "elasticloadbalancing:RegisterInstancesWithLoadBalancer",
                        "fsx:DeleteBackup",
                        "fsx:DeleteFileSystem",
                        "guardduty:CreateD*",
                        "guardduty:Delete*",
                        "guardduty:UpdateDetector",
                        "iam:UpdateAssumeRolePolicy",
                        "kms:CancelKeyDeletion",
                        "kms:Create*",
                        "kms:Delete*",
                        "kms:Disable*",
                        "kms:Enable*",
                        "kms:Put*",
                        "kms:ReplicateKey",
                        "kms:Revoke*",
                        "kms:ScheduleKeyDeletion",
                        "kms:Update*",
                        "lambda:CreateFunction",
                        "lambda:DeleteFunction",
                        "lightsail:Delete*",
                        "lightsail:RebootInstance",
                        "lightsail:StartInstance",
                        "lightsail:StopInstance",
                        "logs:DeleteLogGroup",
                        "rds:Create*",
                        "rds:Delete*",
                        "rds:Modify*",
                        "rds:RebootDBInstance",
                        "rds:RestoreDBInstanceFromDBSnapshot",
                        "rds:Start*",
                        "rds:Stop*",
                        "redshift:DeleteClusterSecurityGroup",
                        "redshift:DeleteClusterSubnetGroup",
                        "s3:CreateBucket",
                        "s3:DeleteBucket",
                        "s3:DeleteObject",
                        "s3:Put*",
                        "s3:RestoreObject",
                        "secretsmanager:RestoreSecret",
                        "ses:DeleteConfigurationSet",
                        "sns:CreateTopic",
                        "sns:DeleteEndpoint",
                        "sns:DeleteTopic",
                        "ssm:CancelCommand",
                        "ssm:SendCommand",
                        "ssm:StartAutomationExecution",
                        "ssm:StopAutomationExecution",
                        "workspaces:ModifyWorkspaceProperties",
                        "workspaces:RebootWorkspaces",
                        "workspaces:StartWorkspaces",
                        "workspaces:StopWorkspaces",
                        "workspaces:TerminateWorkspaces"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"RoleName"
               }
            ]
         }
      }
   }
}
